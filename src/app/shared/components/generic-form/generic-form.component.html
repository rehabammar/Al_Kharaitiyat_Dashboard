<div class="button-wrapper">
  <app-button
    [label]="'createInsert'"
    [imageSrc]="'/assets/img/icon/createInsert.png'"
    [onClick]="addNewRow"
    [showButton]="buttonVisibility.showInsert!">
  </app-button>

  <app-button
    [label]="commitLabel || 'commit'"
    [imageSrc]="'/assets/img/icon/save.svg'"
    [onClick]="save"
    [showButton]="buttonVisibility.showSave!">
  </app-button>

  <app-button
    [label]="'delete'"
    [imageSrc]="'/assets/img/icon/delete.svg'"
    [color]="'#dc3545'"
    [onClick]="openDeletePopup"
    [showButton]="buttonVisibility.showDelete!">
  </app-button>
</div>

<!-- bind a local variable `row` to avoid ?. warnings -->
<div class="generic-form-container" *ngIf="selectedRow as row">
  <div class="form-grid">
    <div *ngFor="let column of columns">
      <!-- Label -->
      <div class="header-label-line align-start">
        <label class="form-label">{{ column.labelKey | translate }}</label>
        <span *ngIf="column.required" class="required-indicator">*</span>
      </div>

      <!-- FLAG -->
      <ng-container *ngIf="column.isFlag; else notFlag" >
        <div class="icon-wrapper"
             (click)="toggleFlag(column.field)"
             [class.disabled]="!editable || column.disabled">
          <img *ngIf="row[column.field] == 1"
               src="/assets/img/icon/tick.png"
               class="status-image" alt="Checked" />
          <img *ngIf="row[column.field] != 1"
               src="/assets/img/icon/untick.png"
               class="status-image" alt="Unchecked" />
        </div>
      </ng-container>

      <!-- if NOT flag -->
      <ng-template #notFlag>
        <!-- COMBOBOX -->
        <ng-container *ngIf="column.isCombobox; else normalField">
          <app-combobox-search
            [apiPath]="column.apiPath!"
            [dataFactory]="column.dataFactory!"
            [primaryKey]="column.primaryKey!"
            [displayItemKey]="column.displayItemKey!"
            [selectedKey]="row[column.fieldFK!]"
            (itemSelected)="onComboSelected(column, $event)"
            [hasError]="isInvalid(column)">
          </app-combobox-search>

          <div class="error-text" *ngIf="isInvalid(column)">
            {{ 'validation.requiredSelect' | translate }}
          </div>
        </ng-container>
      </ng-template>

      <!-- NORMAL INPUT -->
      <ng-template #normalField>
        <div class="input-wrapper"
             *ngIf="(alwaysEditable || editable) && !column.disabled; else readOnly">

          <ng-container [ngSwitch]="column.dataType">

            <!-- DATE INPUT -->
            <input *ngSwitchCase="'date'"
                   class="custom-input date-field"
                   matInput
                   type="datetime-local"
                   [value]="toLocalInput(row[column.field])"
                   (input)="onDateInput(column, $any($event.target).value)"
                   (change)="onDateInput(column, $any($event.target).value)"
                   (blur)="markTouched()"
                   [class.input-error]="isInvalid(column)" />
            <!-- password INPUT -->

            <input *ngSwitchCase="'password'"
                   type="password"
                   class="custom-input"
                   [attr.name]="column.field"
                   [(ngModel)]="row[column.field]"
                   (ngModelChange)="onFieldChanged(column, $event)"
                   [class.input-error]="isInvalid(column)" />
        
          <div class="phone-field" *ngSwitchCase="'mobile'">
          <span class="prefix">+974</span>
          <input
            type="tel"
            class="custom-input ltr-input"
            dir="ltr"
            inputmode="numeric"
            placeholder="XXXXXXXX"
            [ngModel]="localMobile"
            (ngModelChange)="onLocalChanged($event, column)"
            maxlength="8"
            [class.input-error]="isInvalid(column)" />
            </div>
    
            <!-- DEFAULT (STRING/NUMBER/ETC) -->
            <input *ngSwitchDefault
                   class="custom-input"
                   [attr.name]="column.field"
                   [(ngModel)]="row[column.field]"
                   (ngModelChange)="onFieldChanged(column, $event)"
                   [class.input-error]="isInvalid(column)" />
          </ng-container>


          <div class="error-text" *ngIf="isInvalid(column)">
            {{ 'validation.required' | translate }}
          </div>

          <!-- <div class="error-text" *ngIf="isRequiredError(column)">
            {{ 'validation.required' | translate }}
          </div>

          <div class="error-text" *ngIf="isInvalid(column)">
            {{ column.dataType === 'mobile' 
                ? ('validation.invalid' | translate) 
                : ('validation.required' | translate) }}
          </div> -->


                    
        </div>

        <!-- READ ONLY -->
       
    <ng-template #readOnly>
    <ng-container *ngIf="column.dataType === 'date'; else plain">
      <span class="custom-label">
        <ng-container *ngIf="row[column.field]; else dash">
          {{ row[column.field] | date:'yyyy-MM-dd hh:mm a' }}
        </ng-container>
        <ng-template #dash>â€”</ng-template>
      </span>
    </ng-container>
    <ng-template #plain>
      <span class="custom-label" [dir]="column.dataType === 'mobile' ? 'ltr' : 'auto'">
        {{row[column.field]}}
      </span>
    </ng-template>


</ng-template>
      </ng-template>
    </div>
  </div>
</div>
