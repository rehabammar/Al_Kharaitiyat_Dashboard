<div class="button-wrapper">
  <app-button
    [label]="'createInsert'"
    [imageSrc]="'/assets/img/icon/createInsert.png'"
    [onClick]="addNewRow"
    [showButton]="buttonVisibility.showInsert!"
    [disabled]="isLoading">
  </app-button>
    <!-- 
      <pre>
    selectedRow: {{ selectedRow == null}}
    isLoading: {{ isLoading }}
    isDirty: {{ isDirty }}
    saveDisabled: {{ saveDisabled }}
    </pre>  -->
  <app-button
    [label]="commitLabel || 'commit'"
    [imageSrc]="'/assets/img/icon/save.svg'"
    [onClick]="save"
    [showButton]="buttonVisibility.showSave!"
    [disabled]="!this.selectedRow || this.isLoading">
  </app-button>

  <app-button
    [label]="'delete'"
    [imageSrc]="'/assets/img/icon/delete.svg'"
    [color]="'#dc3545'"
    [onClick]="openDeletePopup"
    [showButton]="buttonVisibility.showDelete!"
    [disabled]="!selectedRow || isLoading">
  </app-button>
</div>

<!-- bind a local variable `row` to avoid ?. warnings -->
<div class="generic-form-container" *ngIf="selectedRow as row">
  <div class="form-grid">
    <div *ngFor="let column of columns"   [class.full-row]="column.fullRow || column.dataType === 'longtext'">
      <!-- Label -->
      <div class="header-label-line align-start">
        <label class="form-label">{{ column.labelKey | translate }}</label>
        <span *ngIf="column.required" class="required-indicator">*</span>
      </div>

      <!-- FLAG -->
      <ng-container *ngIf="column.isFlag; else notFlag" >
        <div class="icon-wrapper"
             (click)="toggleFlag(column.field)"
             [class.disabled]="!editable || column.disabled">
          <img *ngIf="row[column.field] == 1"
               src="/assets/img/icon/tick.png"
               class="status-image" alt="Checked" />
          <img *ngIf="row[column.field] != 1"
               src="/assets/img/icon/untick.png"
               class="status-image" alt="Unchecked" />
        </div>
      </ng-container>

      <!-- if NOT flag -->
      <ng-template #notFlag>
        <!-- COMBOBOX -->
        <ng-container *ngIf="column.isCombobox; else normalField">
          <app-combobox-search
            [apiPath]="column.apiPath!"
            [dataFactory]="column.dataFactory!"
            [primaryKey]="column.primaryKey!"
            [displayItemKey]="column.displayItemKey!"
            [selectedKey]="row[column.fieldFK!]"
            (itemSelected)="onComboSelected(column, $event)"
            [params]="getComboParams(column)"      
            [hasError]="isInvalid(column)"
            [forceUpdate]="column.forceUpdateCombobox || false"
            >
          </app-combobox-search>

          <div class="error-text" *ngIf="isInvalid(column)">
            {{ 'validation.requiredSelect' | translate }}
          </div>
        </ng-container>
      </ng-template>

      <!-- NORMAL INPUT -->
      <ng-template #normalField>
        <div class="input-wrapper"
             *ngIf="(alwaysEditable || editable) && !column.disabled; else readOnly">

          <ng-container [ngSwitch]="column.dataType">

            <!-- DATE-TIME INPUT -->
            <input *ngSwitchCase="'datetime'"
                   class="custom-input date-field"
                   matInput
                   type="datetime-local"
                   [value]="toLocalInput(row[column.field],'datetime')"
                   (input)="onDateInput(column, $any($event.target).value)"
                   (change)="onDateInput(column, $any($event.target).value)"
                   (blur)="markTouched()"
                   [disabled]="column.disabled"
                   [class.input-error]="isInvalid(column)" />
            <!-- DATE INPUT -->
              <input *ngSwitchCase="'date'"
                   class="custom-input date-field"
                   matInput
                   type="date"
                   [value]="toLocalInput(row[column.field] , 'date')"
                   (input)="onDateInput(column, $any($event.target).value)"
                   (change)="onDateInput(column, $any($event.target).value)"
                   (blur)="markTouched()"
                   [disabled]="column.disabled"
                   [class.input-error]="isInvalid(column)" />
            <!-- password INPUT -->

            <input *ngSwitchCase="'password'"
                   type="password"
                   class="custom-input"
                   [attr.name]="column.field"
                   [(ngModel)]="row[column.field]"
                   (ngModelChange)="onFieldChanged(column, $event)"
                   [class.input-error]="isInvalid(column)" />
        
            <div class="phone-field" *ngSwitchCase="'mobile'">
            <span class="prefix">+974</span>
            <input
              type="tel"
              class="custom-input ltr-input"
              dir="ltr"
              inputmode="numeric"
              placeholder="XXXXXXXX"
              [ngModel]="localMobile[column.field] || ''"
              (ngModelChange)="onLocalChanged($event, column)"
              maxlength="8"
              [class.input-error]="isInvalid(column)" />
            </div>
            <!-- PERCENT INPUT -->
            <div class="percent-field" *ngSwitchCase="'percentage'">
              <input
                type="number"
                class="custom-input"
                [attr.name]="column.field"
                [(ngModel)]="row[column.field]"
                (ngModelChange)="onPercentChanged(column, $event)"
                [class.input-error]="isInvalid(column)"
                min="0"
                max="100"
              />
              <span class="suffix">%</span>
            </div>

            <!-- EVALUATION (1..5 stars) -->
            <div class="stars"
                *ngSwitchCase="'evaluation'"
                role="radiogroup"
                [attr.aria-label]="'Rating ' + (safeIntRating(row[column.field]) || 0) + ' of 5'"
                (keydown)="onRatingKeydown($event, column, row)">

              <ng-container *ngFor="let _ of five; let i = index">
                <button
                  type="button"
                  class="star"
                  [class.filled]="i < safeIntRating(row[column.field])"
                  [attr.aria-checked]="i + 1 === safeIntRating(row[column.field])"
                  role="radio"
                  (click)="setRating(column, row, i + 1)"
                  [disabled]="column.disabled">
                  ★
                  <span class="sr-only">{{ i + 1 }}</span>
                </button>
              </ng-container>

              <button type="button"
                class="clear-rating"
                (click)="setRating(column, row, null)"
                [disabled]="column.disabled"
                aria-label="Clear rating">
                ×
              </button>


            </div>

            <textarea *ngSwitchCase="'longtext'"
                      class="custom-textarea"
                      [attr.name]="column.field"
                      [(ngModel)]="row[column.field]"
                      (ngModelChange)="onFieldChanged(column, $event)"
                      [rows]="column.rows || 4"
                      [attr.maxLength]="column.maxLength || 4000"
                      [class.input-error]="isInvalid(column)">
            </textarea>

    
            <!-- DEFAULT (STRING/NUMBER/ETC) -->
            <input *ngSwitchDefault
                   class="custom-input"
                   [attr.name]="column.field"
                   [(ngModel)]="row[column.field]"
                   (ngModelChange)="onFieldChanged(column, $event)"
                   [class.input-error]="isInvalid(column)" />
       
          </ng-container>


          <div class="error-text" *ngIf="isInvalid(column)">
            {{ 'validation.required' | translate }}
          </div>

          <!-- <div class="error-text" *ngIf="isRequiredError(column)">
            {{ 'validation.required' | translate }}
          </div>

          <div class="error-text" *ngIf="isInvalid(column)">
            {{ column.dataType === 'mobile' 
                ? ('validation.invalid' | translate) 
                : ('validation.required' | translate) }}
          </div> -->


                    
        </div>

        <!-- READ ONLY -->
       
   <ng-template #readOnly>
  <div>
    <!-- date -->
    <ng-container *ngIf="column.dataType === 'datetime'; else notDate">
      <input
                   class="custom-input date-field"
                   matInput
                   type="datetime-local"
                   [value]="toLocalInput(row[column.field])"
                   [disabled]="true" />
    </ng-container>

    <!-- غير التاريخ -->
    <ng-template #notDate>
      <!-- currency -->
      <ng-container *ngIf="column.dataType === 'currency'; else plain">
        <span class="custom-label">
          <ng-container *ngIf="row[column.field] != null; else dash">
            {{ row[column.field] | number:'1.2-2' }}
            {{ 'FinancialTransactions.Currency' | translate }}
          </ng-container>
          <ng-template #dash>—</ng-template>
        </span>
      </ng-container>

      <!-- النصوص العادية -->
      <ng-template #plain>
        <span class="custom-label" [dir]="column.dataType === 'mobile' ? 'ltr' : 'auto'">
          {{ row[column.field] || '—' }}
        </span>
      </ng-template>
    </ng-template>
  </div>
</ng-template>


  </ng-template>
    </div>
  </div>
</div>
